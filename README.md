# NickK8s

## Goal of this repo
This repo spin up a full Avi environment in vCenter in conjunction with K8s clusters including AKO in order to demonstrate:
- AKO installation inside K8s: command generated by the output
- K8s deployment:  ```k apply -f deployment.yml```
- K8s service type ClusterIP: ```k apply -f service_clusterIP.yml```
- Scale your deployment: ```k scale deployment web-front1 --replicas=6)```
- Create an ingress (unsecured): ```k apply -f ingress.yml```
- Create a secured ingress (based on a TLS cert already configured in a K8s secret): ```k apply -f secure_ingress.yml```
- Apply a WAF policy to your secured ingress: ```k apply -f avi_crd_hostrule_waf.yml```
- Upgrade your unsecured ingress to a secure ingress (based on a TLS cert already configured in the Avi Controller): ```k apply -f avi_crd_hostrule_tls_cert.yml```


## Prerequisites:
- Terraform:
```shell
Terraform v1.0.6
on linux_amd64
+ provider registry.terraform.io/hashicorp/local v2.1.0
+ provider registry.terraform.io/hashicorp/null v3.1.0
+ provider registry.terraform.io/hashicorp/template v2.2.0
+ provider registry.terraform.io/hashicorp/tls v3.1.0
+ provider registry.terraform.io/hashicorp/vsphere v2.0.2
```
https://learn.hashicorp.com/tutorials/terraform/install-cli

- GOVC:
```shell
govc v0.24.0
```
https://github.com/vmware/govmomi/tree/master/govc

- Inside the target vCenter:
  - Have a VM template ready for Avi Controller called ```controller-21.1.1-template```
  - Have a VM template ready for Ubuntu focal called ```ubuntu-focal-20.04-cloudimg-template```
  - Have a VM template ready for Ubuntu bionic called ```ubuntu-bionic-18.04-cloudimg-template```


## Variables:
- define the following environment variables:
  - ```vsphere_user```
  - ```vsphere_password```
  - ```vsphere_server```
  - ```avi_password```
  - ```avi_username```
  - ```avi_vsphere_user```
  - ```avi_vsphere_password```
  - ```avi_vsphere_server # use IP and not FQDN```
  - ```docker_registry_username # this will avoid download issue when downloading docker images```
  - ```docker_registry_password # this will avoid download issue when downloading docker images```
  - ```docker_registry_email # this will avoid download issue when downloading docker images```

- define the following vCenter variables inside variables.tf
```
variable "vcenter" {
  type = map
  default = {
    dc = "wdc-06-vc12"
    cluster = "wdc-06-vc12c01"
    datastore = "wdc-06-vc12c01-vsan"
    resource_pool = "wdc-06-vc12c01/Resources"
    folder = "Nic_K8S" # needs to be changed if duplicate this repo
    networkMgmt = "vxw-dvs-34-virtualwire-3-sid-6120002-wdc-06-vc12-avi-mgmt"
  }
}
```


1. All the parameters/variables defined in variables.tf

## Use the terraform script to:
- Create new folder within v-center:
    - one for the Avi Apps
    - one for the Avi controller
- Create NSX-T segment(s)
- Create Content Library and populate it with the OVA(s) mentioned above 
- Spin up 1 Avi Controller VM(s) - Clone from Content Library
- Spin up 2 backend VM(s) - Clone from Content Library
- Spin up 1 jump VM with ansible installed  - Clone from Content Library - userdata to install packages
- Request Public IP(s) for Jump host, Controller and Virtual Services
- Create NSX-T NAT Rule(s) for Jump host, Controller and Virtual Services
- Create NSX-T policy Group for Jump host, Controller and Virtual Services
- Create NSX-T Gateway Policies for Jump host, Controller and Virtual Services
- Call ansible to do the Avi configuration (git clone)

## Run the terraform:
- build:
```
cd ~ ; git clone https://github.com/tacobayle/aviVmc ; cd aviVmc ; python3 python/getSDDCDetails.py ; /bin/bash ./beforeTf.sh ; terraform init ; terraform apply -var-file=sddc.json -var-file=ip.json -var-file=data.json -var-file=EasyAviLocation.json -var-file=vCenterIp.json -auto-approve
```
- destroy:
```
cd ~/aviVmc ; /bin/bash destroy.sh
```